<button id="menuButton" class="menu-button">☰</button>
<nav id="sideMenu" class="side-menu">
  <ul>
    <li><a routerLink="/">Inicio</a></li>
    <li><a routerLink="/catalogo" *ngIf="authService.isCaja()">Catálogo</a></li>
    <li><a routerLink="/historial" *ngIf="authService.isCaja()">Historial</a></li>
    <li><a routerLink="/productividad" *ngIf="authService.isCaja()">Productividad</a></li>
  </ul>
</nav>

<div class="container">
  <div class="header">
    <h1>📜 Historial de Pedidos</h1>
    <button routerLink="/" class="btn-back">Volver al Inicio</button>
  </div>
  
  <div class="filtros-container">
    <h2>Filtros</h2>
    <div class="filtros-grid">
      <div class="filtro-grupo">
        <label for="fechaInicio">Fecha Inicio:</label>
        <input type="date" id="fechaInicio" [(ngModel)]="fechaInicio">
      </div>
      
      <div class="filtro-grupo">
        <label for="fechaFin">Fecha Fin:</label>
        <input type="date" id="fechaFin" [(ngModel)]="fechaFin">
      </div>
      
      <div class="filtro-grupo">
        <label for="filtroTipo">Tipo:</label>
        <select id="filtroTipo" [(ngModel)]="filtroTipo">
          <option value="todos">Todos</option>
          <option value="mesa">Mesa</option>
          <option value="paraLlevar">Para Llevar</option>
          <option value="delivery">Delivery</option>
        </select>
      </div>
      
      <div class="filtro-grupo">
        <label for="filtroMetodoPago">Método de Pago:</label>
        <select id="filtroMetodoPago" [(ngModel)]="filtroMetodoPago">
          <option value="todos">Todos</option>
          <option value="efectivo">Efectivo</option>
          <option value="yape">Yape</option>
          <option value="tarjeta">Tarjeta</option>
        </select>
      </div>
      
      <div class="filtro-acciones">
        <button class="btn" (click)="aplicarFiltros()">🔍 Aplicar Filtros</button>
        <button class="btn-secondary" (click)="limpiarFiltros()">📅 Hoy</button>
        <button class="btn-secondary" (click)="mostrarTodosLosDatos()">📊 Todos los Datos</button>
      </div>
    </div>
  </div>
  
  <div class="resumen-container">
    <div class="summary-cards">
      <div class="summary-card total">
        <h3>💰 Total</h3>
        <div class="amount">S/ {{ calcularTotal().toFixed(2) }}</div>
      </div>
      
      <div class="summary-card efectivo">
        <h3>💵 Efectivo</h3>
        <div class="amount">S/ {{ calcularTotalPorMetodo('efectivo').toFixed(2) }}</div>
      </div>
      
      <div class="summary-card yape">
        <h3>📱 Yape</h3>
        <div class="amount">S/ {{ calcularTotalPorMetodo('yape').toFixed(2) }}</div>
      </div>
      
      <div class="summary-card tarjeta">
        <h3>💳 Tarjeta</h3>
        <div class="amount">S/ {{ calcularTotalPorMetodo('tarjeta').toFixed(2) }}</div>
      </div>
    </div>
  </div>
  
  <div class="historial-container">
    <div class="historial-header">
      <h2>Resultados ({{ historialPedidos.length }}{{ totalRegistrosEnBD > 0 ? ' de ' + totalRegistrosEnBD + ' total' : '' }})</h2>
      <button class="btn-export" (click)="exportarCSV()" *ngIf="historialPedidos.length > 0">📊 Exportar CSV</button>
    </div>
    
    <div class="loading-indicator" *ngIf="cargando">
      <p>🔄 Cargando historial...</p>
    </div>
    
    <div class="tabla-container" *ngIf="historialPedidos.length > 0">
      <table class="tabla-historial">
        <thead>
          <tr>
            <th>Tipo</th>
            <th>Número</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Método</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pedido of historialPedidos">
            <td>{{ pedido.tipo }}</td>
            <td>{{ pedido.numero }}</td>
            <td>{{ pedido.fecha | date:'short' }}</td>
            <td>S/ {{ pedido.total.toFixed(2) }}</td>
            <td>{{ pedido.metodoPago }}</td>
            <td>
              <button class="btn-small" (click)="verDetallesPedido(pedido)">Ver detalles</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="no-resultados" *ngIf="historialPedidos.length === 0 && !cargando">
      <div class="no-resultados-content">
        <h3 *ngIf="totalRegistrosEnBD === 0">📋 No hay datos en la base de datos</h3>
        <h3 *ngIf="totalRegistrosEnBD > 0">📋 No hay resultados para los filtros</h3>
        
        <p *ngIf="totalRegistrosEnBD === 0">
          Aún no se han registrado pedidos en el sistema.
        </p>
        <p *ngIf="totalRegistrosEnBD > 0">
          No se encontraron pedidos para los filtros seleccionados.
          <br><small>Hay {{ totalRegistrosEnBD }} registro(s) total(es) en la base de datos.</small>
        </p>
        
        <div class="sugerencias" *ngIf="totalRegistrosEnBD > 0">
          <p><strong>Sugerencias:</strong></p>
          <ul>
            <li>Verifica que las fechas incluyan el período deseado</li>
            <li>Intenta ampliar el rango de fechas</li>
            <li>Revisa que los filtros de tipo y método de pago sean correctos</li>
            <li>Haz clic en "Mostrar Todos" para ver todos los datos disponibles</li>
          </ul>
        </div>
        
        <div class="sugerencias" *ngIf="totalRegistrosEnBD === 0">
          <p><strong>Para empezar:</strong></p>
          <ul>
            <li>Ve a la página principal y realiza algunos pedidos</li>
            <li>Procesa los pagos de los pedidos</li>
            <li>Los datos aparecerán automáticamente en el historial</li>
          </ul>
        </div>
        
        <button class="btn" (click)="limpiarFiltros()" *ngIf="totalRegistrosEnBD > 0">🔄 Mostrar Todos los Datos</button>
        <button class="btn" routerLink="/" *ngIf="totalRegistrosEnBD === 0">🏠 Ir al Inicio</button>
      </div>
    </div>
  </div>
  
  <!-- Acciones de Base de Datos -->
  <div class="db-actions" *ngIf="authService.isCaja()">
    <h3>🗄️ Gestión de Base de Datos</h3>
    <div class="db-buttons-container">
      <button class="btn-db btn-export" (click)="exportarBD()">
        <span class="btn-icon">📤</span>
        <span class="btn-text">Exportar BD</span>
      </button>
      <button class="btn-db btn-import" (click)="fileInput.click()">
        <span class="btn-icon">📥</span>
        <span class="btn-text">Importar BD</span>
      </button>
      <button class="btn-db btn-clear" (click)="limpiarBD()">
        <span class="btn-icon">🗑️</span>
        <span class="btn-text">Limpiar BD</span>
      </button>
    </div>
    <input type="file" #fileInput style="display:none;" accept=".json" (change)="importarBD($event)" />
  </div>
</div>